---
title: "Bob Orchestrator Workflow"
---

# Workflow: Bob Orchestrator

**ID:** `bob-orchestrator`
**Vers√£o:** 1.1
**Tipo:** Meta-Workflow (Orquestra√ß√£o Aut√¥noma)
**Autor:** @architect (Aria)
**Data de Cria√ß√£o:** 2026-02-05
**√öltima Atualiza√ß√£o:** 2026-02-05
**Epic de Refer√™ncia:** Epic 12 - Bob Full Integration v1.6
**Tags:** bob, orchestrator, automation, meta-workflow, autonomous

---

## Vis√£o Geral

O **Bob Orchestrator** √© o meta-workflow central do AIOS que orquestra todo o ciclo de desenvolvimento de forma aut√¥noma. Bob √© ativado atrav√©s do `@pm` com perfil `bob` e atua como um orquestrador que:

- Detecta o estado do projeto automaticamente
- Decide qual workflow executar (Greenfield, Brownfield, Enhancement)
- Spawna agentes em terminais separados para trabalho paralelo
- Gerencia o ciclo de desenvolvimento story por story
- Mant√©m estado persistente entre sess√µes
- Interrompe para aprova√ß√£o humana em pontos de decis√£o

### Princ√≠pio Fundamental: CLI First

```
CLI First ‚Üí Observability Second ‚Üí UI Third
```

| Camada | Prioridade | Descri√ß√£o |
|--------|------------|-----------|
| **CLI** | M√°xima | Onde a intelig√™ncia vive. Toda execu√ß√£o, decis√µes e automa√ß√£o. |
| **Observability** | Secund√°ria | Observar e monitorar o que acontece no CLI em tempo real. |
| **UI** | Terci√°ria | Gest√£o pontual e visualiza√ß√µes quando necess√°rio. |

### Casos de Uso Principais

| Cen√°rio | Recomendado |
|---------|-------------|
| Projeto novo do zero | Sim (PATH D: Greenfield) |
| Projeto existente sem docs AIOS | Sim (PATH B: Brownfield Discovery) |
| Projeto AIOS com novas features | Sim (PATH C: Enhancement) |
| Primeira vez no AIOS | Sim (PATH A: Onboarding) |
| Hotfixes urgentes | N√£o - use @dev diretamente |
| Tasks pontuais | N√£o - use agentes individuais |

---

## Diagrama Geral do Workflow

### Mapa Completo do Bob

```mermaid
flowchart TB
    subgraph STARTUP["1. STARTUP"]
        A1[("@pm ativado")] --> A2["resolveConfig() / L1‚ÜíL2‚ÜíL3‚ÜíL4‚ÜíL5"]
        A2 --> A3["user_profile / == 'bob'?"]
        A3 -->|N√£o| PM_TRAD["PM Tradicional / STOP"]
        A3 -->|Sim| A4["CLEANUP autom√°tico / (locks, sessions, snapshots)"]
        A4 --> A5["sessionStateExists()?"]
    end

    subgraph SESSION["2. SESSION CHECK"]
        A5 --> S1["Existe / .session-state.yaml?"]
        S1 -->|Sim + Crash| S2["CRASH RECOVERY"]
        S1 -->|Sim + Normal| S3["SESSION RESUME"]
        S1 -->|N√£o| S4["DECISION TREE"]
    end

    subgraph RESUME["2b. RESUME OPTIONS"]
        S2 --> R1["[1] CONTINUE / [2] REVIEW / [3] RESTART / [4] DISCARD"]
        S3 --> R1
        R1 --> |CONTINUE| DEV_CYCLE
        R1 --> |REVIEW| R2["Mostra progresso"] --> R1
        R1 --> |RESTART| DEV_CYCLE
        R1 --> |DISCARD| S4
    end

    subgraph TREE["3. DECISION TREE"]
        S4 --> T1["Tem config?"]
        T1 -->|N√£o| PA["PATH A: / ONBOARDING"]
        T1 -->|Sim| T2["Tem docs AIOS?"]
        T2 -->|N√£o| PB["PATH B: / BROWNFIELD"]
        T2 -->|Sim| PC["PATH C: / ENHANCEMENT"]
        T1 -->|Projeto vazio| PD["PATH D: / GREENFIELD"]
    end

    subgraph PATHS["4. PATHS"]
        PA --> |"Setup completo"| S4
        PB --> |"Discovery completo"| PC
        PD --> |"Arquitetura pronta"| PC
        PC --> ENHANCEMENT
    end

    subgraph ENHANCEMENT["5. ENHANCEMENT WORKFLOW"]
        E1["Classificar pedido"] --> E2["Precisa PRD?"]
        E2 -->|Sim| E3["spawn @pm / create-prd"]
        E2 -->|N√£o| E4
        E3 --> E4["spawn @pm / create-epic"]
        E4 --> E5["spawn @sm / create-story-drafts"]
        E5 --> E6["Para cada story: / @po validate"]
        E6 --> DEV_CYCLE
    end

    subgraph DEV_CYCLE["6. DEVELOPMENT CYCLE"]
        direction TB
        D1["PHASE 1: VALIDATION / @po - 10min"] --> D2["PHASE 2: DEVELOPMENT / executor - 2h"]
        D2 --> D3["PHASE 3: SELF-HEALING / @dev - 30min"]
        D3 --> D4["PHASE 4: QUALITY GATE / quality_gate - 30min"]
        D4 --> D5["PHASE 5: PUSH / @devops - 10min"]
        D5 --> D6["PHASE 6: CHECKPOINT / @po - HUMANO"]
    end

    subgraph CHECKPOINT["7. CHECKPOINT"]
        D6 --> C1["Op√ß√£o?"]
        C1 -->|GO| C2["Pr√≥xima story"] --> D1
        C1 -->|PAUSE| C3["Salvar estado / FIM"]
        C1 -->|REVIEW| C4["Mostrar changes"] --> D6
        C1 -->|ABORT| C5["Epic interrompido / FIM"]
        C2 --> |"Todas completas"| DONE
    end

    subgraph COMPLETION["8. CONCLUS√ÉO"]
        DONE(["üéâ Epic Complete!"])
        DONE --> S4
    end

    style A1 fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px
    style DONE fill:#90EE90,stroke:#2E7D32,stroke-width:3px
    style PA fill:#FFE4B5,stroke:#F57C00
    style PB fill:#FFE4B5,stroke:#F57C00
    style PC fill:#ADD8E6,stroke:#1976D2
    style PD fill:#FFE4B5,stroke:#F57C00
    style DEV_CYCLE fill:#E8F5E9,stroke:#4CAF50
    style D6 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
```

---

## Diagrama de Sequ√™ncia: Fluxo Completo

```mermaid
sequenceDiagram
    autonumber
    participant U as Usu√°rio
    participant BOB as Bob (@pm)
    participant AR as @architect
    participant SM as @sm
    participant PO as @po
    participant DEV as @dev / executor
    participant QG as Quality Gate
    participant DOP as @devops
    participant OBS as Observability

    rect rgb(255, 248, 220)
        Note over BOB: STARTUP
        U->>BOB: Ativar @pm (perfil bob)
        BOB->>BOB: resolveConfig() L1‚ÜíL5
        BOB->>BOB: CLEANUP (locks, sessions)
        BOB->>BOB: sessionStateExists()?
    end

    alt Sess√£o anterior existe
        rect rgb(240, 230, 140)
            Note over BOB: SESSION RESUME
            BOB->>U: "Detectei sess√£o anterior..."
            U->>BOB: [1] CONTINUE | [2] REVIEW | [3] RESTART | [4] DISCARD
        end
    end

    rect rgb(173, 216, 230)
        Note over BOB: DECISION TREE
        BOB->>BOB: Analisar projeto (determin√≠stico)
        alt PATH A: Onboarding
            BOB->>U: "Primeira vez? Vamos configurar..."
        else PATH B: Brownfield
            BOB->>AR: spawn 'analyze-structure'
            BOB->>U: "Encontrei d√©bitos t√©cnicos..."
        else PATH C: Enhancement
            BOB->>U: "O que quer fazer?"
        else PATH D: Greenfield
            BOB->>AR: spawn 'create-full-stack-architecture'
        end
    end

    rect rgb(221, 160, 221)
        Note over BOB,SM: ENHANCEMENT WORKFLOW
        BOB->>SM: spawn 'create-prd' (se necess√°rio)
        SM-->>BOB: PRD criado
        BOB->>SM: spawn 'create-epic'
        SM-->>BOB: Epic com stories
        loop Para cada story
            BOB->>PO: spawn 'validate-story-draft'
            PO-->>BOB: Story validada
        end
    end

    rect rgb(152, 251, 152)
        Note over BOB,DOP: DEVELOPMENT CYCLE (por story)

        BOB->>OBS: setPipelineStage('validation')
        BOB->>PO: PHASE 1: Validar story
        PO-->>BOB: OK

        BOB->>OBS: setPipelineStage('development')
        BOB->>DEV: PHASE 2: spawn executor (terminal limpo)
        DEV->>DEV: Implementar + testes
        DEV-->>BOB: C√≥digo pronto

        alt CodeRabbit habilitado
            BOB->>OBS: setPipelineStage('self-healing')
            BOB->>DEV: PHASE 3: CodeRabbit scan
            DEV-->>BOB: Issues filtrados (CRITICAL/HIGH)
        end

        BOB->>OBS: setPipelineStage('quality-gate')
        BOB->>QG: PHASE 4: spawn quality_gate (‚â† executor)
        QG->>QG: Review c√≥digo + ACs
        alt Quality Gate OK
            QG-->>BOB: APPROVED
        else Quality Gate FAIL
            QG-->>DEV: Feedback para fixes
            DEV-->>QG: Re-submit
        end

        BOB->>OBS: setPipelineStage('push')
        BOB->>DOP: PHASE 5: spawn @devops 'push-story'
        DOP->>DOP: Pre-push checks + git push + PR
        DOP-->>BOB: PR criada

        BOB->>OBS: setPipelineStage('checkpoint')
        BOB->>U: PHASE 6: "‚úÖ Story completa! [GO/PAUSE/REVIEW/ABORT]"
    end

    alt GO
        U->>BOB: GO
        Note over BOB: Pr√≥xima story ‚Üí volta ao DEVELOPMENT CYCLE
    else PAUSE
        U->>BOB: PAUSE
        BOB->>BOB: recordPause() ‚Üí .session-state.yaml
        BOB-->>U: "At√© logo!"
    else ABORT
        U->>BOB: ABORT
        BOB-->>U: "Epic interrompido. Progresso salvo."
    end
```

---

## Steps Detalhados

### 1. STARTUP SEQUENCE

| Atributo | Valor |
|----------|-------|
| **Step ID** | `startup` |
| **Trigger** | Ativa√ß√£o de `@pm` |
| **Timeout** | 30s |
| **M√≥dulo** | `config-resolver.js` |

#### Processo

```mermaid
flowchart LR
    A["@pm ativado"] --> B["resolveConfig()"]
    B --> C["L1: Framework / .aios-core/framework-config.yaml"]
    C --> D["L2: Project / .aios-core/project-config.yaml"]
    D --> E["Pro: Extension / pro/pro-config.yaml"]
    E --> F["L3: App / apps/*/aios-app.config.yaml"]
    F --> G["L4: Local / .aios-core/local-config.yaml"]
    G --> H["L5: User / ~/.aios/user-config.yaml"]
    H --> I["user_profile / == 'bob'?"]
    I -->|N√£o| J["PM Tradicional"]
    I -->|Sim| K["BOB Mode"]
```

#### Config Hierarchy (PRO-4 + Epic 12.1/12.2)

| Layer | Local | Escopo | Git |
|-------|-------|--------|-----|
| **L1 Framework** | `.aios-core/framework-config.yaml` | Read-only, ships com npm | ‚úó |
| **L2 Project** | `.aios-core/project-config.yaml` | Team-shared | ‚úì |
| **Pro Extension** | `pro/pro-config.yaml` | Opcional | ‚úì |
| **L3 App** | `apps/*/aios-app.config.yaml` | Monorepo | ‚úì |
| **L4 Local** | `.aios-core/local-config.yaml` | Machine-specific | ‚úó |
| **L5 User** | `~/.aios/user-config.yaml` | Cross-project, per-user | ‚úó |

#### Config Resolvido

| Campo | Descri√ß√£o | Default |
|-------|-----------|---------|
| `user_profile` | `bob` ou `advanced` | `bob` |
| `educational_mode` | Painel detalhado | `false` |
| `coderabbit_integration` | Self-healing ativo | `true` |
| `default_model` | Modelo padr√£o | `claude-opus-4-5-20250514` |
| `default_language` | Idioma | `pt` |

---

### 2. CLEANUP AUTOM√ÅTICO

| Atributo | Valor |
|----------|-------|
| **Step ID** | `cleanup` |
| **M√≥dulo** | `session-state.js` |
| **Execu√ß√£o** | Autom√°tica no startup |

#### O que √© limpo

| Item | Crit√©rio | A√ß√£o |
|------|----------|------|
| Lock files | TTL expirado ou PID morto | Remover |
| Sessions | > 30 dias sem update | Arquivar |
| Snapshots | > 90 dias | Remover (manter index) |

#### Output

```
Cleanup: 2 locks, 1 session, 0 snapshots removed
```

---

### 3. SESSION CHECK

| Atributo | Valor |
|----------|-------|
| **Step ID** | `session_check` |
| **Arquivo** | `.aios/.session-state.yaml` |
| **M√≥dulo** | `session-state.js` |

#### Detec√ß√£o de Crash

```mermaid
flowchart TB
    A["Ler .session-state.yaml"] --> B["last_updated / > 30min?"]
    B -->|Sim| C["CRASH detectado"]
    B -->|N√£o| D["PAUSE normal"]
    C --> E["Mostrar contexto / + op√ß√µes de recovery"]
    D --> F["Mostrar progresso / + op√ß√µes de resume"]
```

#### Op√ß√µes de Resume

| Op√ß√£o | Descri√ß√£o | A√ß√£o |
|-------|-----------|------|
| **CONTINUE** | Retoma de onde parou | `loadSessionState()` ‚Üí execute() |
| **REVIEW** | Mostra o que foi feito | `getProgressSummary()` ‚Üí pergunta |
| **RESTART** | Reinicia story atual | reset story ‚Üí execute() do in√≠cio |
| **DISCARD** | Arquiva sess√£o | `discard()` ‚Üí DECISION TREE |

---

### 4. DECISION TREE

| Atributo | Valor |
|----------|-------|
| **Step ID** | `decision_tree` |
| **Tipo** | Script determin√≠stico (N√ÉO LLM) |
| **M√≥dulo** | `bob-orchestrator.js` |

#### √Årvore de Decis√£o

```mermaid
flowchart TB
    START["Analisar projeto"] --> Q1["Tem config / resolvido?"]
    Q1 -->|N√£o| PA["PATH A: / ONBOARDING"]
    Q1 -->|Sim| Q2["Tem docs AIOS? / (architecture.md, stories/)"]
    Q2 -->|N√£o| PB["PATH B: / BROWNFIELD DISCOVERY"]
    Q2 -->|Sim| PC["PATH C: / ENHANCEMENT"]
    Q1 -->|Diret√≥rio vazio| PD["PATH D: / GREENFIELD"]

    PA --> |"Setup completo"| START
    PB --> |"Discovery completo"| PC
    PD --> |"Arquitetura pronta"| PC

    style PA fill:#FFE4B5
    style PB fill:#FFE4B5
    style PC fill:#ADD8E6
    style PD fill:#FFE4B5
```

---

### 5. PATH A: ONBOARDING

| Atributo | Valor |
|----------|-------|
| **Condi√ß√£o** | Config n√£o resolvido |
| **Dura√ß√£o** | 10-15 min |
| **Story Epic 12** | 12.1, 12.9 |
| **Interativo** | Sim |

#### Processo

1. Pergunta perfil do usu√°rio
2. Cria arquivos de config
3. Setup GitHub (se necess√°rio)
4. Volta ao DECISION TREE

#### Pergunta de Perfil (PRD ¬ß2.4)

```
ü§ñ Bem-vindo ao AIOS!

Quando uma IA gera c√≥digo para voc√™, qual op√ß√£o te descreve melhor?

[1] üü¢ Modo Assistido (Recomendado)
    ‚Üí "N√£o sei avaliar se o c√≥digo est√° certo ou errado"

[2] üîµ Modo Avan√ßado
    ‚Üí "Consigo identificar quando algo est√° errado e corrigir"

Escolha [1/2]:
```

#### Instala√ß√£o via NPX (Story 12.9)

```bash
npx @synkra/aios-install
```

O instalador:
- Detecta OS (macOS, Windows/WSL, Linux)
- Verifica depend√™ncias (Node ‚â•18, Git, Docker, gh)
- Pergunta perfil
- Cria `~/.aios/user-config.yaml` (L5)
- Executa Environment Bootstrap
- &lt; 5 minutos em conex√£o m√©dia

---

### 6. PATH B: BROWNFIELD DISCOVERY

| Atributo | Valor |
|----------|-------|
| **Condi√ß√£o** | Projeto existente SEM docs AIOS |
| **Dura√ß√£o** | 2-4 horas |
| **Story Epic 12** | 12.8 |
| **M√≥dulo** | `terminal-spawner.js` |

#### Diagrama de Sequ√™ncia

```mermaid
sequenceDiagram
    participant BOB as Bob
    participant AR as @architect
    participant DE as @data-engineer
    participant UX as @ux-design-expert
    participant DOP as @devops
    participant U as Usu√°rio

    Note over BOB: FASE 1: An√°lise Paralela
    par Terminais em paralelo
        BOB->>AR: spawn 'analyze-structure'
        BOB->>DE: spawn 'analyze-db'
        BOB->>UX: spawn 'analyze-ui'
        BOB->>DOP: spawn 'analyze-infra'
    end

    AR-->>BOB: an√°lise sistema
    DE-->>BOB: an√°lise database
    UX-->>BOB: an√°lise frontend
    DOP-->>BOB: an√°lise infra

    Note over BOB: FASE 2: Consolida√ß√£o
    BOB->>AR: consolidar an√°lises
    AR-->>BOB: architecture.md + technical-debt-report.md

    Note over BOB: SURFACE: M√∫ltiplas op√ß√µes
    BOB->>U: "Encontrei N d√©bitos. / [1] Resolver d√©bitos / [2] Adicionar feature"
    U->>BOB: Escolha
    BOB->>BOB: ‚Üí PATH C com contexto
```

#### ObservabilityPanel durante Brownfield

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ü§ñ Bob ‚Äî Brownfield Discovery     ‚è± 2m15s  ‚îÇ
‚îÇ Terminals: 4 active                         ‚îÇ
‚îÇ @architect ‚óè | @data-engineer ‚óè |           ‚îÇ
‚îÇ @ux-design ‚óè | @devops ‚óè                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 7. PATH C: ENHANCEMENT WORKFLOW

| Atributo | Valor |
|----------|-------|
| **Condi√ß√£o** | Projeto AIOS com docs existentes |
| **Story Epic 12** | 12.3 |
| **M√≥dulo** | `executor-assignment.js` |

#### Classifica√ß√£o do Pedido

| Tipo | Workflow | PRD Necess√°rio |
|------|----------|----------------|
| `new_feature` | Enhancement completo | Sim (se grande) |
| `bug_fix` | Bug Fix Flow | N√£o |
| `refactoring` | Refactoring Flow | N√£o |
| `tech_debt` | Tech Debt Flow | N√£o |

#### Diagrama do Enhancement

```mermaid
flowchart TB
    subgraph CLASSIFY["Classifica√ß√£o"]
        A["Usu√°rio descreve pedido"] --> B["Bob classifica"]
        B --> C["Tipo?"]
        C -->|new_feature| D1["Enhancement Workflow"]
        C -->|bug_fix| D2["Bug Fix Flow"]
        C -->|refactoring| D3["Refactoring Flow"]
        C -->|tech_debt| D4["Tech Debt Flow"]
    end

    subgraph SURFACE["Surface Check"]
        D1 --> S1["Custo > $5?"]
        S1 -->|Sim| S2["Bob: 'Isso vai consumir ~$X. Confirma?'"]
        S1 -->|N√£o| S3["Risco HIGH?"]
        S3 -->|Sim| S4["Bob: 'Risco alto. GO/NO-GO?'"]
        S3 -->|N√£o| PRD
    end

    subgraph PRD_EPIC["PRD + Epic"]
        PRD["FASE 1: PRD"] --> EPIC["FASE 2: EPIC"]
        EPIC --> STORIES["FASE 3: STORY DRAFTS"]
        STORIES --> VALIDATE["PO Validation"]
        VALIDATE --> DEV["‚Üí DEVELOPMENT CYCLE"]
    end
```

#### Dynamic Executor Assignment

Dentro do Epic, cada story recebe:

| Campo | Descri√ß√£o | Exemplo |
|-------|-----------|---------|
| `executor` | Agente que implementa | `@dev`, `@data-engineer` |
| `quality_gate` | Agente que revisa (‚â† executor) | `@architect`, `@dev` |
| `quality_gate_tools` | Ferramentas do QG | `[code_review, arch_review]` |

---

### 7b. PATH D: GREENFIELD WORKFLOW

| Atributo | Valor |
|----------|-------|
| **Condi√ß√£o** | Projeto novo (sem `package.json`, `.git`, `docs/`) |
| **Story Epic 12** | 12.13 |
| **M√≥dulo** | `greenfield-handler.js` |
| **Workflow** | `greenfield-fullstack.yaml` |

#### Diagrama do Greenfield

```mermaid
flowchart TB
    subgraph DETECT["Detec√ß√£o"]
        A["Bob detecta Greenfield"] --> B["Nenhum package.json / nem .git nem docs/?"]
        B -->|Sim| C["Acionar greenfield-fullstack.yaml"]
    end

    subgraph PHASE0["Phase 0: Environment Bootstrap"]
        C --> D["spawn @devops / 'environment-bootstrap.md'"]
        D --> E["Setup: git, npm, estrutura"]
    end

    subgraph PHASE1["Phase 1: Discovery &amp; Planning"]
        E --> F["spawn @analyst / 'market-research'"]
        F --> G["spawn @pm / 'create-prd'"]
        G --> H["spawn @ux-design-expert / 'user-journeys'"]
        H --> I["spawn @architect / 'create-full-stack-architecture'"]
        I --> J["spawn @po / 'validate-architecture'"]
    end

    subgraph PHASE2["Phase 2: Document Sharding"]
        J --> K["spawn @po / 'shard-prd'"]
        K --> L["PRD ‚Üí Epic ‚Üí Stories"]
    end

    subgraph PHASE3["Phase 3: Development"]
        L --> M["‚Üí DEVELOPMENT CYCLE / (reutiliza WorkflowExecutor)"]
    end

    style PHASE0 fill:#FFE4B5
    style PHASE1 fill:#ADD8E6
    style PHASE2 fill:#DDA0DD
    style PHASE3 fill:#98FB98
```

#### Sequ√™ncia de Agentes (Phase 1)

| Ordem | Agente | Task | Output |
|-------|--------|------|--------|
| 1 | @analyst | market-research | `docs/research/market-analysis.md` |
| 2 | @pm | create-prd | `docs/prd/PRD.md` |
| 3 | @ux-design-expert | user-journeys | `docs/ux/user-journeys.md` |
| 4 | @architect | create-full-stack-architecture | `docs/architecture/architecture.md` |
| 5 | @po | validate-architecture | Aprova√ß√£o |

#### Surface Decisions

- GO/PAUSE entre cada phase
- Session state persiste fase atual para resume
- Se agente falha ‚Üí Retry / Skip / Abort
- Workflow idempotente ‚Äî re-executar atualiza, n√£o duplica

---

### 8. DEVELOPMENT CYCLE

| Atributo | Valor |
|----------|-------|
| **Step ID** | `development_cycle` |
| **Story Epic 12** | 12.3 |
| **M√≥dulo** | `workflow-executor.js` |
| **Repeti√ß√£o** | Uma vez por story |

#### Vis√£o Geral das Fases

```mermaid
flowchart LR
    P1["PHASE 1 / VALIDATION / @po / 10min"] --> P2["PHASE 2 / DEVELOPMENT / executor / 2h"]
    P2 --> P3["PHASE 3 / SELF-HEALING / @dev / 30min"]
    P3 --> P4["PHASE 4 / QUALITY GATE / quality_gate / 30min"]
    P4 --> P5["PHASE 5 / PUSH / @devops / 10min"]
    P5 --> P6["PHASE 6 / CHECKPOINT / @po / HUMANO"]

    style P1 fill:#FFE4B5
    style P2 fill:#98FB98
    style P3 fill:#87CEEB
    style P4 fill:#DDA0DD
    style P5 fill:#F0E68C
    style P6 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
```

---

### 8.1 PHASE 1: VALIDATION

| Atributo | Valor |
|----------|-------|
| **Agente** | @po (Pax) |
| **Timeout** | 10 min |
| **Error Handler** | `reject_with_feedback` ‚Üí volta ao SM |

#### Checklist de Valida√ß√£o

- [ ] Executor atribu√≠do?
- [ ] Quality gate ‚â† executor?
- [ ] Acceptance criteria claros?
- [ ] Epic context consistente?
- [ ] Files_to_modify identificados?

#### Epic Context Accumulator (Story 12.4)

O PO valida a story usando contexto acumulado com **sumariza√ß√£o progressiva**:

```mermaid
flowchart LR
    subgraph RECENT["N-3 to N-1 (Full Detail)"]
        R1["600 tokens max/story"]
        R2["Todos os campos"]
    end

    subgraph MEDIUM["N-6 to N-4 (50%)"]
        M1["id, title, executor"]
        M2["status, files_modified"]
    end

    subgraph OLD["1 to N-7 (10%)"]
        O1["id, executor, status"]
    end

    RECENT --> CONTEXT["Accumulated Context / ‚â§ 8000 tokens"]
    MEDIUM --> CONTEXT
    OLD --> CONTEXT
```

**N√≠veis de Compress√£o:**

| N√≠vel | Campos | Aplica-se a | Tokens |
|-------|--------|-------------|--------|
| `full_detail` | id, title, executor, quality_gate, status, acceptance_criteria, files_modified, dev_notes | N-3 to N-1 | ‚â§600/story |
| `metadata_plus_files` | id, title, executor, status, files_modified | N-6 to N-4 | ~200/story |
| `metadata_only` | id, executor, status | 1 to N-7 | ~50/story |

**Exce√ß√µes (override para `metadata_plus_files`):**
- Story tocou arquivos que Story N vai modificar (file overlap)
- Story do mesmo executor que Story N

**Cascata de Compress√£o (se exceder 8000 tokens):**
1. `metadata_only` nas stories mais antigas
2. Remover `files_modified` das m√©dias
3. Truncar `dev_notes` das recentes
4. Remover `acceptance_criteria` das recentes

---

### 8.2 PHASE 2: DEVELOPMENT

| Atributo | Valor |
|----------|-------|
| **Agente** | `$[story.executor]` (din√¢mico) |
| **Timeout** | 2 horas |
| **M√≥dulo** | `terminal-spawner.js` |
| **Error Handler** | `return_to_po` (max 3 tentativas) |

#### Surface Check Antes de Spawnar

```javascript
surfaceChecker.shouldSurface({
  action_type: 'spawn_agent',
  estimated_cost: calculado,
  risk_level: calculado
})
```

Se `should_surface: true` ‚Üí Bob interrompe e mostra ao usu√°rio.

#### Execu√ß√£o em Terminal Limpo

```mermaid
flowchart TB
    subgraph SPAWN["spawn executor"]
        A["Agente recebe:"] --> B["- Story completa com ACs"]
        B --> C["- Arquivos relevantes"]
        C --> D["- Epic context comprimido"]
    end

    subgraph EXEC["Execu√ß√£o"]
        D --> E["Implementar c√≥digo"]
        E --> F["Rodar testes unit√°rios"]
        F --> G["Gerar output"]
    end

    subgraph COLLECT["Coleta"]
        G --> H["Bob coleta via pollForOutput()"]
        H --> I["sessionState.recordPhaseChange()"]
    end
```

---

### 8.3 PHASE 3: SELF-HEALING

| Atributo | Valor |
|----------|-------|
| **Agente** | @dev |
| **Timeout** | 30 min |
| **Condi√ß√£o** | `coderabbit_integration.enabled == true` |
| **Max Iterations** | 3 |

#### Fluxo Self-Healing

```mermaid
flowchart TB
    A["CodeRabbit CLI scan"] --> B["Parse output"]
    B --> C["Filtrar: apenas CRITICAL e HIGH"]
    C --> D["Issues / encontrados?"]
    D -->|N√£o| E["‚úì C√≥digo limpo! / ‚Üí Phase 4"]
    D -->|Sim| F["iteration < 3?"]
    F -->|Sim| G["attemptAutoFix()"]
    G --> H["iteration++"]
    H --> A
    F -->|N√£o| I["Log issues para QG avaliar"]
    I --> E

    style E fill:#90EE90
```

---

### 8.4 PHASE 4: QUALITY GATE

| Atributo | Valor |
|----------|-------|
| **Agente** | `$[story.quality_gate]` (sempre ‚â† executor) |
| **Timeout** | 30 min |
| **Error Handler** | `return_to_development` (max 3 tentativas) |

#### Regra de Assignment

| Executor | Quality Gate |
|----------|--------------|
| @dev | @architect |
| @data-engineer | @dev |
| @devops | @architect |

#### Checklist do Reviewer

- [ ] C√≥digo atende acceptance criteria?
- [ ] Segue patterns da arquitetura?
- [ ] Testes adequados?
- [ ] Sem regress√µes?

#### Resultado

| Decis√£o | A√ß√£o |
|---------|------|
| **APPROVED** | ‚Üí Phase 5 |
| **REJECTED** | ‚Üí volta Phase 2 com feedback |

Se 3 falhas ‚Üí SURFACE: Bob pede ajuda humana.

---

### 8.5 PHASE 5: PUSH

| Atributo | Valor |
|----------|-------|
| **Agente** | @devops (Gage) |
| **Timeout** | 10 min |
| **Surface** | Obrigat√≥rio (C005: destructive_action) |

#### Processo

```mermaid
flowchart LR
    A["Pre-push checks"] --> B["npm run lint"]
    B --> C["npm run typecheck"]
    C --> D["npm test"]
    D --> E["git add + commit"]
    E --> F["git push"]
    F --> G["gh pr create"]
    G --> H["PR URL retornada"]
```

#### Surface Check Obrigat√≥rio

```
Bob: "Vou fazer push da Story 7.4 para main. Confirma?"
```

(ou autom√°tico se yolo mode / n√£o-destrutivo)

---

### 8.6 PHASE 6: CHECKPOINT

| Atributo | Valor |
|----------|-------|
| **Agente** | @po |
| **Timeout** | 30 min |
| **Elicit** | **SEMPRE** (humano decide) |

#### *** AQUI O BOB SEMPRE PARA E PERGUNTA AO HUMANO ***

```
Bob: "‚úÖ Story 7.4 completa! PR #42 criada.

  Progresso: 4/8 stories completas
  Pr√≥xima: Story 7.5 ‚Äî Implementar refresh tokens
  Executor: @data-engineer | QG: @dev

  [GO]     ‚Üí Continuar para pr√≥xima story
  [PAUSE]  ‚Üí Salvar e continuar depois
  [REVIEW] ‚Üí Quero ver o que foi feito
  [ABORT]  ‚Üí Parar o √©pico"
```

#### A√ß√µes

| Op√ß√£o | A√ß√£o |
|-------|------|
| **GO** | `recordPhaseChange()` ‚Üí pr√≥xima story ‚Üí Phase 1 |
| **PAUSE** | `recordPause()` ‚Üí salva estado ‚Üí "At√© logo!" |
| **REVIEW** | mostra changes, files, PRs ‚Üí pergunta de novo |
| **ABORT** | "Epic interrompido. Progresso salvo." ‚Üí FIM |

---

## Surface Criteria (Quando Bob Interrompe)

A cada decis√£o significativa, ANTES de agir:

```javascript
surfaceChecker.shouldSurface(context)
```

### Ordem de Avalia√ß√£o (primeira match ganha)

| C√≥digo | Crit√©rio | A√ß√£o |
|--------|----------|------|
| **C005** | A√ß√£o destrutiva? (delete, drop, force_push, rm_rf) | **SEMPRE confirma. NUNCA bypass√°vel.** |
| **C002** | Risco HIGH? | "üî¥ Risco alto. GO/NO-GO?" |
| **C004** | 2+ erros na mesma task? | "‚è∏ Encontrei problemas. Preciso de ajuda." |
| **C001** | Custo > $5? | "üí∞ Isso vai consumir ~$X. Confirma?" |
| **C006** | Escopo expandiu? | "üìè Escopo cresceu. Confirma expans√£o?" |
| **C003** | 2+ op√ß√µes v√°lidas sem info? | "üîÄ Encontrei N op√ß√µes. Qual?" |
| **C007** | Depend√™ncia externa? | "üîó Preciso de [chave/acesso]. Pode fornecer?" |

---

## Observability

### CLI Panel (SEMPRE FUNCIONA ‚Äî zero depend√™ncias)

#### Modo Minimal (educational_mode: false ‚Äî DEFAULT)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ü§ñ Bob                          ‚è± 23m15s   ‚îÇ
‚îÇ [PRD ‚úì] ‚Üí [Epic ‚úì] ‚Üí [3/8] ‚Üí [Dev ‚óè] ‚Üí QA ‚îÇ
‚îÇ @dev ‚Äî implementing jwt-handler             ‚îÇ
‚îÇ Terminals: 2 (@dev, @data-engineer)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
~8 linhas, refresh 1s

#### Modo Detailed (educational_mode: true)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ü§ñ Bob                          ‚è± 23m15s   ‚îÇ
‚îÇ [PRD ‚úì] ‚Üí [Epic ‚úì] ‚Üí [3/8] ‚Üí [Dev ‚óè] ‚Üí QA ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Current: @dev (Dex)                         ‚îÇ
‚îÇ Task: implementing jwt-handler              ‚îÇ
‚îÇ Why: Story type 'code_general' ‚Üí @dev       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Tradeoffs considered:                       ‚îÇ
‚îÇ  ‚Ä¢ jose vs jsonwebtoken (chose jose: ESM)   ‚îÇ
‚îÇ  ‚Ä¢ Stateless vs DB sessions (chose JWT)     ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Terminals: 2                                ‚îÇ
‚îÇ  @dev pid:12345 ‚Äî jwt-handler (4m32s)       ‚îÇ
‚îÇ  @data-engineer pid:12346 ‚Äî schema (2m15s)  ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Next: Quality Gate ‚Üí @architect             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
~20 linhas, refresh 1s

### Dashboard (OPCIONAL ‚Äî consome bob-status.json + WebSocket)

```mermaid
flowchart LR
    BOB["Bob Orchestrator"] --> OBS["Observability Layer"]
    OBS --> CLI["CLI Panel / (stdout)"]
    OBS --> JSON["bob-status.json / (.aios/dashboard/)"]
    OBS --> WS["WebSocket / (:4001)"]
    JSON --> DASH["Dashboard"]
    WS --> DASH
```

#### Dashboard Components

| Component | Descri√ß√£o |
|-----------|-----------|
| `BobPipelinePanel` | Progress visual do pipeline |
| `BobAgentActivity` | Terminais ativos com status |
| `BobSurfaceAlert` | Alertas quando checkpoint pendente |
| Kanban badges | Badge ü§ñ quando Bob orquestra |
| Status bar | "Bob: active \| @dev working \| Story 3/8" |

---

## Modo Educativo (Story 12.7)

| Atributo | Valor |
|----------|-------|
| **Config** | `educational_mode: false` em L5 (default OFF) |
| **Toggle Sess√£o** | Persiste em `session-state.yaml` (`overrides.educational_mode`) |
| **Toggle Permanente** | Persiste em `user-config.yaml` (L5) |

### Compara√ß√£o de Modos

**Modo OFF (default):**
```
Bob: "‚úÖ Autentica√ß√£o JWT implementada. 4 arquivos criados."
```

**Modo ON:**
```
Bob: "Vou criar autentica√ß√£o JWT. Isso envolve:
üìö Por que JWT? Stateless, escal√°vel...
üîß O que vou fazer: @data-engineer cria tabela, @dev implementa handler...
Quer que eu execute?"
```

### Toggle via Comando

```
"Bob, ativa modo educativo"
```

---

## Data Architecture

### Mapa de Persist√™ncia

| Dado | Formato | Local | Ciclo de Vida | Consumidores |
|------|---------|-------|---------------|--------------|
| User Config (L5) | YAML | `~/.aios/user-config.yaml` | Permanente (cross-project) | Bob, greeting-builder |
| Project Config (L2) | YAML | `.aios-core/project-config.yaml` | Permanente (per-project, git) | Bob, agents |
| Session State | YAML | `docs/stories/.session-state.yaml` | Ativo ‚Üí Arquivar ap√≥s 30 dias | Bob, Epic Context |
| Lock Files | YAML | `.aios/locks/*.lock` | TTL 300s + auto-cleanup | Bob |
| Epic Context | In-memory | N/A (computed on-demand) | Ef√™mero | PO |
| Bob Status | JSON | `.aios/dashboard/bob-status.json` | Atualizado a cada fase, stale ap√≥s 5min | CLI Panel, Dashboard |
| Snapshots | JSON | `.aios/snapshots/*.json` | Remover ap√≥s 90 dias | Bob |
| Timeline | JSON | `.aios/timeline/unified-timeline.json` | Permanente (append-only) | Dashboard |

### Lock File Schema (Story 12.3)

```yaml
# .aios/locks/<resource>.lock
pid: 12345                    # PID do processo que adquiriu o lock
owner: "bob-orchestrator"     # Identificador do m√≥dulo
created_at: "2026-02-05T..."  # ISO timestamp de aquisi√ß√£o
ttl_seconds: 300              # Auto-expire ap√≥s 5 minutos (default)
resource: "session-state"     # Recurso sendo protegido
```

**Cleanup autom√°tico no startup:**
- Lock files com TTL expirado ‚Üí remover
- Lock files de PIDs inexistentes ‚Üí remover
- Retry strategy: se lock ativo, esperar 2s e re-checar (max 3 tentativas)

### Schema bob-status.json (Story 12.6)

```json
{
  "version": "1.0",
  "timestamp": "ISO8601",
  "orchestration": {
    "active": true,
    "mode": "bob",
    "epic_id": "epic-12",
    "current_story": "12.3"
  },
  "pipeline": {
    "stages": ["validation", "development", "self_healing", "quality_gate", "push", "checkpoint"],
    "current_stage": "development",
    "story_progress": "3/8",
    "completed_stages": ["validation"]
  },
  "current_agent": {
    "id": "dev",
    "name": "Dex",
    "task": "implementing jwt-handler",
    "reason": "Story type: code_general ‚Üí executor: dev",
    "started_at": "ISO8601"
  },
  "active_terminals": [
    { "agent": "dev", "pid": 12345, "task": "jwt-handler", "elapsed": "4m32s" }
  ],
  "surface_decisions": [
    { "criteria": "C003", "action": "present_options", "timestamp": "ISO8601", "resolved": false }
  ],
  "elapsed": {
    "story_seconds": 272,
    "session_seconds": 1380
  },
  "errors": [],
  "educational": {
    "enabled": false,
    "tradeoffs": [],
    "reasoning": []
  }
}
```

### WebSocket Events (Story 12.6)

```typescript
type BobEvent =
  | { type: 'BobPhaseChange'; phase: string; story: string; executor: string }
  | { type: 'BobAgentSpawned'; agent: string; pid: number; task: string }
  | { type: 'BobAgentCompleted'; agent: string; pid: number; success: boolean; duration: number }
  | { type: 'BobSurfaceDecision'; criteria: string; action: string; context: object }
  | { type: 'BobError'; phase: string; message: string; recoverable: boolean }
```

### Fluxo de Dados CLI + Dashboard

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  Config Resolver  ‚îÇ ‚Üê L1‚ÜíL2‚ÜíPro‚ÜíL3‚ÜíL4‚ÜíL5 merge
                    ‚îÇ  (config-resolver ‚îÇ
                    ‚îÇ   .js - PRO-4)   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ resolveConfig()
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Bob Orchestrator (12.3)             ‚îÇ
‚îÇ  reads: config, session-state, stories, locks   ‚îÇ
‚îÇ  writes: session-state, locks, bob-status.json  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ              ‚îÇ              ‚îÇ
       ‚ñº              ‚ñº              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇEpic Context‚îÇ ‚îÇSession     ‚îÇ ‚îÇ  Observability Layer (12.6)      ‚îÇ
‚îÇAccumulator ‚îÇ ‚îÇState       ‚îÇ ‚îÇ  WRITES TO:                     ‚îÇ
‚îÇ(12.4)      ‚îÇ ‚îÇ(11.5/12.5) ‚îÇ ‚îÇ  ‚îú‚îÄ‚îÄ stdout (panel-renderer.js) ‚îÇ
‚îÇ8000 tokens ‚îÇ ‚îÇcrash/resume‚îÇ ‚îÇ  ‚îú‚îÄ‚îÄ bob-status.json (file)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ  ‚îî‚îÄ‚îÄ WebSocket events (if up)    ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                         ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ                    ‚îÇ                    ‚îÇ
                    ‚ñº                    ‚ñº                    ‚ñº
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ  CLI Panel   ‚îÇ   ‚îÇ  Dashboard   ‚îÇ   ‚îÇ  Dashboard   ‚îÇ
           ‚îÇ  (terminal)  ‚îÇ   ‚îÇ  Polling     ‚îÇ   ‚îÇ  WebSocket   ‚îÇ
           ‚îÇ              ‚îÇ   ‚îÇ  /api/bob/   ‚îÇ   ‚îÇ  :4001       ‚îÇ
           ‚îÇ  ALWAYS      ‚îÇ   ‚îÇ  status      ‚îÇ   ‚îÇ  /stream     ‚îÇ
           ‚îÇ  WORKS       ‚îÇ   ‚îÇ              ‚îÇ   ‚îÇ              ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ                   ‚îÇ
                                     ‚ñº                   ‚ñº
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ  Dashboard Bob Panel (12.12)     ‚îÇ
                              ‚îÇ  bob-store.ts ‚Üí BobPipelinePanel ‚îÇ
                              ‚îÇ  + BobAgentActivity              ‚îÇ
                              ‚îÇ  + BobSurfaceAlert               ‚îÇ
                              ‚îÇ  + Kanban card badges            ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Princ√≠pio CLI First aplicado:**
- CLI Panel (stdout) **SEMPRE funciona** ‚Äî zero depend√™ncias externas
- Dashboard √© **consumidor opcional** ‚Äî enriquece mas nunca √© requisito
- Bob escreve para ambos via mesma Observability Layer (single writer)
- Dashboard tem fallback: WebSocket ‚Üí SSE ‚Üí polling (3 camadas de resili√™ncia)

---

## Terminal Spawning (Story 12.10)

### Cross-Platform Validation

| Plataforma | Terminal | Status |
|------------|----------|--------|
| macOS | Terminal.app, iTerm2 | ‚úÖ |
| Windows | WSL + Windows Terminal | ‚úÖ |
| Linux | gnome-terminal, xterm | ‚úÖ |
| CI/CD | GitHub Actions (ubuntu-latest) | ‚úÖ (fallback inline) |
| Docker | node:18-alpine | ‚úÖ (fallback inline) |

### Fallback Strategy

Se terminal spawn falha:
1. Fallback para execu√ß√£o **inline** (child_process sem terminal visual)
2. Degrada√ß√£o graceful com aviso ao usu√°rio
3. Output corretamente capturado e retornado ao Bob

### Ambientes que Precisam Fallback

| Ambiente | Motivo | Fallback |
|----------|--------|----------|
| VS Code Integrated Terminal | N√£o suporta spawn externo | Inline |
| SSH sessions | Sem display | Inline |
| Docker containers | Sem GUI | Inline |
| CI/CD pipelines | Headless | Inline |

---

## CI/CD Pipeline (Story 12.11)

### GitHub Actions Workflows

| Workflow | Trigger | Prop√≥sito |
|----------|---------|-----------|
| `bob-integration.yml` | PR para `.aios-core/core/` | Valida bob-orchestrator.js |
| `npm-publish.yml` | Tag `v*.*.*` | Publica @synkra/aios-install |
| `cross-platform.yml` | PR | Testa pm.sh em matrix |
| `release.yml` | Release | Gera release notes |

### Quality Gates (Required Status Checks)

- `lint` (ESLint)
- `typecheck` (TypeScript)
- `test` (Jest)
- `bob-integration` (Smoke test do Bob)
- `cross-platform / ubuntu-latest`
- `cross-platform / macos-latest`

---

## Crit√©rios de Sucesso (PRD ¬ß14)

| Crit√©rio | Teste | Meta |
|----------|-------|------|
| **Onboarding Zero-Friction** | Usu√°rio novo instala via NPX e inicia projeto | &lt; 15min |
| **Ciclo de Dev Aut√¥nomo** | Epic de 5 stories executado | GO/PAUSE apenas entre stories |
| **Qualidade de C√≥digo** | Stories passam no quality gate na 1¬™ tentativa | ‚â•70% |
| **Prote√ß√£o de Guardrails** | Usu√°rio Modo Bob nunca v√™ | Merge conflict ou story inconsistente |

---

## Agentes Participantes

```mermaid
mindmap
  root((Bob / Orchestrator))
    Orquestra√ß√£o
      pm["@pm (Morgan) / Bob Mode"]
    Planning
      architect["@architect (Aria) / Arquitetura"]
      sm["@sm (River) / Stories"]
      po["@po (Pax) / Valida√ß√£o"]
    Execu√ß√£o
      dev["@dev (Dex) / Implementa√ß√£o"]
      data-engineer["@data-engineer (Dara) / Database"]
    Quality
      qa["@qa (Quinn) / Quality Gate"]
    Deploy
      devops["@devops (Gage) / Push + PR"]
```

### Perfil dos Agentes

| Agente | ID | Arqu√©tipo | Papel no Bob |
|--------|----|-----------|--------------|
| Morgan | `@pm` | Strategist | Bob Orchestrator (modo bob) |
| Aria | `@architect` | Visionary | An√°lise estrutural, arquitetura |
| River | `@sm` | Facilitator | Cria√ß√£o de stories |
| Pax | `@po` | Balancer | Valida√ß√£o, checkpoints |
| Dex | `@dev` | Builder | Implementa√ß√£o de c√≥digo |
| Dara | `@data-engineer` | Sage | Database, migrations |
| Quinn | `@qa` | Guardian | Quality gates |
| Gage | `@devops` | Operator | Push, PR, CI/CD |

---

## Tasks Executadas

### Mapa de Tasks por M√≥dulo

| Etapa | M√≥dulo(s) Epic 11 | Story Epic 12 | O que acontece |
|-------|-------------------|---------------|----------------|
| Startup | config-resolver (PRO-4) | 12.1, 12.2 | Carrega config L1‚ÜíL5, determina modo |
| Cleanup | session-state.js | 12.5 | Remove locks expirados, arquiva sessions |
| Resume | session-state.js | 12.5 | Detecta crash ou pause, oferece op√ß√µes |
| Decision Tree | ‚Äî | 12.3 | bob-orchestrator.js decide path |
| Brownfield | terminal-spawner.js | 12.8 | Spawna 4 agentes em paralelo |
| PRD/Epic | executor-assignment.js | 12.3 | Cada story recebe executor + QG |
| Story Validation | ‚Äî | 12.4 | PO valida com epic context (‚â§8000 tokens) |
| Development | terminal-spawner.js | 12.3 | Executor roda em terminal limpo |
| Self-Healing | workflow-executor.js | 12.3 | CodeRabbit scan, filter CRITICAL/HIGH |
| Quality Gate | terminal-spawner.js | 12.3 | Reviewer ‚â† executor, terminal separado |
| Push | terminal-spawner.js | 12.3 | @devops faz pre-checks + push + PR |
| Checkpoint | surface-checker.js | 12.3 | SEMPRE para. GO/PAUSE/REVIEW/ABORT |
| Observability CLI | observability-panel.js | 12.6 | panel-renderer.js ‚Üí stdout ANSI |
| Dashboard Bridge | ‚Äî | 12.6 | bob-status.json + WebSocket events |
| Dashboard UI | ‚Äî | 12.12 | BobPipelinePanel + BobAgentActivity |

---

## Pr√©-requisitos

### Configura√ß√£o do Projeto

- [ ] `.aios/config.yaml` com `user_profile: bob`
- [ ] `resolveConfig()` retornando config v√°lido
- [ ] Agentes dispon√≠veis (arquivos em `.aios-core/development/agents/`)

### M√≥dulos Necess√°rios (Epic 11)

| M√≥dulo | Story | Prop√≥sito |
|--------|-------|-----------|
| `config-resolver.js` | PRO-4 | Config hierarchy L1‚ÜíL5 |
| `session-state.js` | 11.5 | Persist√™ncia de sess√£o |
| `surface-checker.js` | 11.3 | Crit√©rios de interrup√ß√£o |
| `workflow-executor.js` | 11.4 | Execu√ß√£o de workflows |
| `terminal-spawner.js` | 11.2 | Spawn de agentes |
| `observability-panel.js` | 11.6 | CLI rendering |

### Ferramentas Integradas

| Ferramenta | Agente | Prop√≥sito |
|------------|--------|-----------|
| `git` | @devops | Push, PR |
| `coderabbit` | @dev, @qa | Self-healing, review |
| `context7` | @analyst | Docs de libs |
| `exa` | @analyst | Research |

---

## Entradas e Sa√≠das

### Entradas do Workflow

| Entrada | Tipo | Fonte | Descri√ß√£o |
|---------|------|-------|-----------|
| User request | string | Usu√°rio | Descri√ß√£o do que quer fazer |
| Config | object | resolveConfig() | Configura√ß√µes do projeto |
| Session state | file | .session-state.yaml | Estado da sess√£o anterior |
| Epic context | file | docs/stories/ | Contexto do epic atual |

### Sa√≠das do Workflow

| Sa√≠da | Tipo | Destino | Descri√ß√£o |
|-------|------|---------|-----------|
| Story files | .md | docs/stories/ | Stories implementadas |
| Code | files | src/ | C√≥digo implementado |
| PRs | GitHub | remote | Pull requests criadas |
| Session state | .yaml | .aios/ | Estado para resume |
| bob-status.json | .json | .aios/dashboard/ | Estado para dashboard |

---

## Pontos de Decis√£o

### Decision Point 1: Qual PATH seguir?

```mermaid
flowchart TB
    Q1["Config existe?"]
    Q1 -->|N√£o| PA["PATH A: Onboarding"]
    Q1 -->|Sim| Q2["Docs AIOS existem?"]
    Q2 -->|N√£o| PB["PATH B: Brownfield"]
    Q2 -->|Sim| PC["PATH C: Enhancement"]
    Q1 -->|Vazio| PD["PATH D: Greenfield"]
```

### Decision Point 2: Precisa de PRD?

| Tipo | PRD Necess√°rio |
|------|----------------|
| Feature grande | Sim |
| Bug fix | N√£o |
| Refactor | N√£o |
| Tech debt | N√£o |

### Decision Point 3: Checkpoint

| Op√ß√£o | Pr√≥xima A√ß√£o |
|-------|--------------|
| GO | Pr√≥xima story |
| PAUSE | Salvar e sair |
| REVIEW | Mostrar e perguntar |
| ABORT | Encerrar epic |

---

## Troubleshooting

### Problema: Bob n√£o ativa (PM tradicional)

**Sintoma:** `@pm` ativa sem modo Bob

**Causas:**
- `user_profile` n√£o √© `bob` no config
- Config n√£o resolvido corretamente

**Solu√ß√£o:**
```yaml
# .aios/config.yaml
user_profile: bob
```

---

### Problema: Session resume falha

**Sintoma:** N√£o consegue retomar sess√£o anterior

**Causas:**
- `.session-state.yaml` corrompido
- PID de terminal morto

**Solu√ß√£o:**
```bash
# Remover session state
rm .aios/.session-state.yaml

# Reiniciar
@pm
```

---

### Problema: Terminal spawn falha

**Sintoma:** Agente n√£o spawna em terminal separado

**Causas:**
- `terminal-spawner.js` n√£o encontrado
- Timeout muito curto

**Solu√ß√£o:**
1. Verificar Epic 11.2 implementado
2. Aumentar timeout no config

---

### Problema: Quality Gate em loop

**Sintoma:** QG rejeita repetidamente

**Causas:**
- Issues n√£o corrigidos
- Feedback n√£o claro

**Solu√ß√£o:**
1. Revisar feedback do QG
2. Se 3 falhas ‚Üí SURFACE ativado
3. Humano interv√©m

---

### Problema: Dashboard n√£o atualiza

**Sintoma:** Dashboard mostra estado desatualizado

**Causas:**
- `bob-status.json` n√£o escrito
- WebSocket n√£o conectado

**Solu√ß√£o:**
1. Verificar `.aios/dashboard/bob-status.json` existe
2. Verificar WebSocket `:4001` ativo
3. **Lembrar:** CLI SEMPRE funciona (CLI First)

---

## Refer√™ncias

### Arquivos do Workflow

| Arquivo | Localiza√ß√£o |
|---------|-------------|
| Bob Orchestrator | `.aios-core/core/orchestration/bob-orchestrator.js` |
| Config Resolver | `.aios-core/core/orchestration/config-resolver.js` |
| Session State | `.aios-core/core/orchestration/session-state.js` |
| Surface Checker | `.aios-core/core/orchestration/surface-checker.js` |
| Workflow Executor | `.aios-core/core/orchestration/workflow-executor.js` |
| Terminal Spawner | `.aios-core/core/orchestration/terminal-spawner.js` |
| Observability Panel | `.aios-core/core/orchestration/observability-panel.js` |
| Panel Renderer | `.aios-core/core/orchestration/panel-renderer.js` |
| Executor Assignment | `.aios-core/core/orchestration/executor-assignment.js` |

### Agentes

| Agente | Localiza√ß√£o |
|--------|-------------|
| @pm (Morgan) | `.aios-core/development/agents/pm.md` |
| @architect (Aria) | `.aios-core/development/agents/architect.md` |
| @sm (River) | `.aios-core/development/agents/sm.md` |
| @po (Pax) | `.aios-core/development/agents/po.md` |
| @dev (Dex) | `.aios-core/development/agents/dev.md` |
| @data-engineer (Dara) | `.aios-core/development/agents/data-engineer.md` |
| @qa (Quinn) | `.aios-core/development/agents/qa.md` |
| @devops (Gage) | `.aios-core/development/agents/devops.md` |

### Documenta√ß√£o Relacionada

- [Story Development Cycle](./story-development-cycle-workflow.md)
- [Brownfield Discovery](./brownfield-discovery-workflow.md)
- [Spec Pipeline](./spec-pipeline-workflow.md)
- [PRD AIOS v2 Bob](../prd/aios-v2-bob/)

### Stories Relacionadas (Epic 12)

| Story | Nome | Prioridade | Descri√ß√£o |
|-------|------|------------|-----------|
| 12.1 | User Profile System | P1-HIGH | L5 User layer, toggle-profile |
| 12.2 | Core Config + Project Config | P1-HIGH | L1-L5 hierarchy, JSON Schema validation |
| 12.3 | Bob Orchestration Logic | P0-CRITICAL | Entry point, Decision Tree, integra√ß√£o Epic 11 |
| 12.4 | Epic Context Accumulator | P0-CRITICAL | Sumariza√ß√£o progressiva, token limits |
| 12.5 | Session State Integration | P1-HIGH | Crash detection, resume, data lifecycle cleanup |
| 12.6 | Observability Panel + Dashboard Bridge | P1-HIGH | panel-renderer.js, bob-status.json, WebSocket |
| 12.7 | Modo Educativo | P2-MEDIUM | Flag educational_mode, toggle |
| 12.8 | Brownfield Discovery | P2-MEDIUM | Detec√ß√£o, an√°lise paralela |
| 12.9 | NPX Installer | P2-MEDIUM | npx @synkra/aios-install |
| 12.10 | Terminal Spawning E2E | P0-CRITICAL | Cross-platform, fallback inline |
| 12.11 | CI/CD Pipeline | P1-HIGH | GitHub Actions, quality gates |
| 12.12 | Dashboard Bob Panel | P1-HIGH | bob-store.ts, componentes UI |
| 12.13 | Greenfield Workflow | P1-HIGH | Pipeline completo: idea ‚Üí code |

### Execution Phases (Ordem Recomendada)

```mermaid
gantt
    title Epic 12 - Execution Phases
    dateFormat  YYYY-MM-DD

    section Fase 1 - Core
    12.3 Bob Orchestration     :a1, 2026-02-10, 5d
    12.10 Terminal Spawning E2E :a2, 2026-02-10, 5d
    12.4 Epic Context          :a3, 2026-02-10, 3d

    section Fase 2 - Config
    12.1 User Profile          :b1, after a1, 3d
    12.2 Config Structure      :b2, after a1, 3d
    12.5 Session Integration   :b3, after a1, 2d

    section Fase 3 - Features
    12.6 Observability + Bridge :c1, after b1, 4d
    12.7 Modo Educativo        :c2, after b2, 2d
    12.8 Brownfield Discovery  :c3, after b1, 3d
    12.13 Greenfield Workflow  :c4, after b1, 4d

    section Fase 4 - Distribution
    12.12 Dashboard Bob Panel  :d1, after c1, 4d
    12.9 NPX Installer         :d2, after c1, 3d
    12.11 CI/CD Pipeline       :d3, after c1, 3d
```

---

## Risk Assessment

| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| Terminal spawning falha em alguns OSs | High | High | Fallback para execu√ß√£o inline |
| Epic Context consome muitos tokens | Medium | Medium | Sumariza√ß√£o progressiva com hard cap 600 tokens/story |
| User Profile complica UX | Low | Medium | Default para "bob", f√°cil trocar |
| NPX installer falha em m√°quinas espec√≠ficas | Medium | High | Community QA testing |
| Config hierarchy conflict | High | High | Estender config-resolver.js com L5 User layer |
| Lock files √≥rf√£os | Medium | Medium | Schema formal com TTL 300s + auto-cleanup |
| Dashboard desacoplado | Medium | High | Single source of truth: bob-status.json |
| WebSocket indispon√≠vel | High | Low | Fallback: file ‚Üí polling ‚Üí SSE (3 camadas) |
| Greenfield pipeline longo | Medium | Medium | Retry/Skip/Abort por agente + session resume |

---

## Changelog

| Vers√£o | Data | Mudan√ßas |
|--------|------|----------|
| 1.0 | 2026-02-05 | Vers√£o inicial do workflow |
| 1.1 | 2026-02-05 | Completado com todas as 13 stories do Epic 12: Config Hierarchy L1-L5, Epic Context Accumulator, Greenfield Workflow, Modo Educativo, Data Architecture, Schemas (bob-status.json, lock files), Terminal Spawning E2E, CI/CD Pipeline, Crit√©rios de Sucesso, Risk Assessment |

---

*Documenta√ß√£o gerada por @architect (Aria)*
*Workflow Version: 1.1*
*CLI First | Observability Second | UI Third*
*Baseado em: Epic 12 - Bob Full Integration v1.6*
