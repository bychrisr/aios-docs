# Standard PR Workflow

The standard pull request workflow in AIOS projects, from code completion through merge and deployment.

## Overview

In AIOS, only @devops (Gage) has authority to push code and create pull requests. All other agents delegate to @devops when code is ready to ship. This ensures consistent branch management and PR quality.

## Creating a PR

After development and QA gate pass:

```
@devops *push
```

The DevOps agent handles:

1. Creating the feature branch (if not already on one)
2. Staging and committing all changes
3. Pushing to the remote repository
4. Creating the pull request with a proper description linking the story

## PR Checklist

Before requesting a push, ensure:

- [ ] All acceptance criteria met
- [ ] Tests passing
- [ ] Lint clean
- [ ] QA gate passed (PASS or CONCERNS)
- [ ] Story file updated with File List
- [ ] No secrets or credentials committed
- [ ] Change Log updated in the story file

## CodeRabbit Integration

AIOS integrates with CodeRabbit for automated code review. CodeRabbit runs in two modes depending on the phase:

### During Development (@dev Phase)

```yaml
mode: light
max_iterations: 2
severity_filter: [CRITICAL, HIGH]
```

- **CRITICAL** findings: Auto-fixed immediately
- **HIGH** findings: Auto-fixed if under 2 iterations, otherwise documented as tech debt
- **MEDIUM** findings: Documented as tech debt
- **LOW** findings: Ignored

If CRITICAL issues persist after 2 iterations, the process halts for manual intervention.

### During QA Review (@qa Phase)

```yaml
mode: full
max_iterations: 3
severity_filter: [CRITICAL, HIGH]
```

QA runs a more thorough review:

1. Pre-commit review scan
2. Self-healing loop (max 3 iterations for auto-fixes)
3. Manual QA analysis (architectural patterns, traceability, non-functional requirements)
4. Gate decision (PASS / CONCERNS / FAIL / WAIVED)

### Running CodeRabbit Manually

```
*coderabbit-review
```

This triggers a standalone CodeRabbit review outside the normal workflow, useful for spot-checking before submission.

## The Self-Healing Loop

When CodeRabbit finds issues, the self-healing loop attempts automatic fixes:

```
CodeRabbit scan --> CRITICAL found?
  YES --> auto-fix --> re-scan (max iterations)
  NO  --> document remaining issues --> proceed
```

After the maximum number of iterations, any remaining CRITICAL issues block the PR until manually resolved. HIGH issues that survive the loop are documented as technical debt.

## QA Review Process

The QA gate runs 7 quality checks:

1. **Code review** -- Patterns, readability, maintainability
2. **Unit tests** -- Adequate coverage, all passing
3. **Acceptance criteria** -- All met per story AC
4. **No regressions** -- Existing functionality preserved
5. **Performance** -- Within acceptable limits
6. **Security** -- OWASP basics verified
7. **Documentation** -- Updated if necessary

### Gate Decisions

| Decision | Meaning | Action |
|----------|---------|--------|
| **PASS** | All checks OK | Proceed to `@devops *push` |
| **CONCERNS** | Minor issues | Approve with observations documented |
| **FAIL** | Critical issues | Return to @dev with specific feedback |
| **WAIVED** | Issues accepted | Approve with documented waiver (rare) |

## Merging

After PR approval:

```
@devops *merge
```

The DevOps agent merges the PR using the configured merge strategy (typically squash merge).

## Expedited Flow (Hotfixes)

For production emergencies:

```
@devops *push --expedite
```

This skips the full QA loop and creates a high-priority PR flagged for immediate review. Use only for P0 issues. See the [Crisis Management](/playbook/workflows/crisis-management) guide for the full war room protocol.

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Push rejected (no remote) | Ensure the repository has a remote configured: `git remote -v` |
| CodeRabbit timeout | Check network connectivity; re-run with `*coderabbit-review` |
| PR conflicts | Rebase locally: `git rebase main`; resolve conflicts; then `@devops *push` |
| QA gate loops indefinitely | Check if acceptance criteria are ambiguous; clarify with @po |
| Push blocked by authority | Only @devops can push; delegate with `@devops *push` |
